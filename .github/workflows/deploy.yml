name: Deploy Blog to GitHub Pages

# 触发条件：推送到main分支或手动触发
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# 设置权限
permissions:
  contents: read
  pages: write
  id-token: write

# 确保同时只有一个部署在运行
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 构建作业
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 检出代码
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史，用于git信息
        
    # 设置Node.js环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 安装依赖
    - name: Install Dependencies
      run: |
        npm ci
        
    # 验证配置文件
    - name: Verify Configuration Files
      run: |
        echo "Using existing _config.yml file..."
        echo "Current _config.yml URL settings:"
        grep -E "^url:|^root:" _config.yml || echo "URL settings not found"

        echo "Checking theme configuration..."
        if [ -f "themes/anzhiyu/_config.yml" ]; then
          echo "AnZhiYu theme config exists"
        else
          echo "Warning: AnZhiYu theme config not found"
        fi

        echo "Node.js version:"
        node --version
        echo "NPM version:"
        npm --version

    # 清理和生成
    - name: Clean and Generate
      run: |
        npx hexo clean
        npx hexo generate

        echo "Generated files:"
        ls -la public/

        echo "Checking index.html:"
        if [ -f "public/index.html" ]; then
          echo "✅ index.html exists"
          head -5 public/index.html
        else
          echo "❌ index.html not found"
          exit 1
        fi
        
    # 设置GitHub Pages
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    # 上传构建产物
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

  # 部署作业
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        timeout: 600000
        error_count: 10
        reporting_interval: 5000

    - name: Verify Deployment
      run: |
        echo "Deployment completed!"
        echo "Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "Expected URL: https://twj0.github.io/blog/"

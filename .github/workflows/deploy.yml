name: Deploy Blog to GitHub Pages

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽgitä¿¡æ¯
        
    # è®¾ç½®Node.jsçŽ¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # å®‰è£…ä¾èµ–
    - name: Install Dependencies
      run: |
        # æ¸…ç†å¯èƒ½æŸåçš„ node_modules
        rm -rf node_modules package-lock.json

        # é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–
        npm install
        npm install hexo-renderer-pug --save

        # éªŒè¯å…³é”®æ’ä»¶å®‰è£…
        echo "éªŒè¯æ’ä»¶å®‰è£…ï¼š"
        ls -la node_modules/hexo-generator-index/
        ls -la node_modules/hexo-renderer-pug/ || echo "Pug renderer not found"
        
    # ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœè®¾ç½®äº†çŽ¯å¢ƒå˜é‡ï¼‰
    - name: Generate Configuration Files
      run: |
        if [ -n "${{ vars.SITE_TITLE }}" ]; then
          echo "ðŸ”§ æ£€æµ‹åˆ°çŽ¯å¢ƒå˜é‡ï¼Œç”Ÿæˆè‡ªå®šä¹‰é…ç½®..."

          # ç”Ÿæˆ _config.yml
          cat > _config.yml << EOF
        # Hexo Configuration
        title: ${{ vars.SITE_TITLE || 'twj0çš„ä¸ªäººåšå®¢' }}
        subtitle: ${{ vars.SITE_SUBTITLE || 'è®°å½•ç”Ÿæ´»ï¼Œåˆ†äº«æŠ€æœ¯' }}
        description: ${{ vars.SITE_DESCRIPTION || 'åŸºäºŽHexoå’ŒAnZhiYuä¸»é¢˜çš„ä¸ªäººåšå®¢' }}
        keywords: ${{ vars.SITE_KEYWORDS || 'blog,hexo,anzhiyu' }}
        author: ${{ vars.AUTHOR_NAME || 'twj0' }}
        language: ${{ vars.SITE_LANGUAGE || 'zh-CN' }}
        timezone: ${{ vars.TIMEZONE || 'Asia/Shanghai' }}

        # URL
        url: ${{ vars.SITE_URL || 'https://twj0.github.io/blog' }}
        root: ${{ vars.SITE_ROOT || '/blog/' }}
        permalink: :year/:month/:day/:title/
        permalink_defaults:
        pretty_urls:
          trailing_index: true
          trailing_html: true

        # Directory
        source_dir: source
        public_dir: public
        tag_dir: tags
        archive_dir: archives
        category_dir: categories
        code_dir: downloads/code
        i18n_dir: :lang
        skip_render:

        # Writing
        new_post_name: :title.md
        default_layout: post
        titlecase: false
        external_link:
          enable: true
          field: site
          exclude: ''
        filename_case: 0
        render_drafts: false
        post_asset_folder: false
        relative_link: false
        future: true
        syntax_highlighter: highlight.js
        highlight:
          line_number: true
          auto_detect: false
          tab_replace: ''
          wrap: true
          hljs: false
        prismjs:
          preprocess: true
          line_number: true
          tab_replace: ''

        # Home page setting
        index_generator:
          path: ''
          per_page: 10
          order_by: -date

        # Category & Tag
        default_category: uncategorized
        category_map:
        tag_map:

        # Metadata elements
        meta_generator: true

        # Date / Time format
        date_format: YYYY-MM-DD
        time_format: HH:mm:ss
        updated_option: 'mtime'

        # Pagination
        per_page: 10
        pagination_dir: page

        # Include / Exclude file(s)
        include:
        exclude:
        ignore:

        # Extensions
        theme: anzhiyu

        # Deployment
        deploy:
          type: git
          repo: https://github.com/twj0/blog.git
          branch: gh-pages
        EOF

          echo "âœ… ä½¿ç”¨çŽ¯å¢ƒå˜é‡ç”Ÿæˆäº†è‡ªå®šä¹‰é…ç½®"
        else
          echo "ðŸ“‹ ä½¿ç”¨çŽ°æœ‰çš„ _config.yml æ–‡ä»¶"
        fi

        echo "å½“å‰é…ç½®æ–‡ä»¶å†…å®¹ï¼š"
        grep -E "^title:|^url:|^root:" _config.yml

    # æ¸…ç†å’Œç”Ÿæˆ
    - name: Clean and Generate
      run: |
        echo "ðŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
        npx hexo clean

        echo "ðŸ—ï¸ ç”Ÿæˆé™æ€æ–‡ä»¶..."
        npx hexo generate

        echo "ðŸ“ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
        ls -la public/ | head -10

        if [ -f "public/index.html" ]; then
          echo "âœ… index.html ç”ŸæˆæˆåŠŸ"
          echo "ðŸ“„ æ–‡ä»¶å¤§å°: $(wc -c < public/index.html) bytes"
        else
          echo "âŒ index.html ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
    # è®¾ç½®GitHub Pages
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        timeout: 600000
        error_count: 10
        reporting_interval: 5000

    - name: Verify Deployment
      run: |
        echo "Deployment completed!"
        echo "Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "Expected URL: https://twj0.github.io/blog/"

# .github/workflows/sync-posts-matrix.yml

name: Sync Blog Posts (Matrix)

on:
  push:
    branches:
      - main
    paths:
      - 'source/_posts/*.md'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # --- æ ¸å¿ƒä¿®æ”¹ï¼šMatrix ç­–ç•¥é…ç½® ---
    strategy:
      # å¦‚æœä¸€ä¸ªä»“åº“åŒæ­¥å¤±è´¥ï¼Œä¸è¦å–æ¶ˆå…¶ä»–ä»“åº“çš„ä»»åŠ¡
      fail-fast: false
      matrix:
        # ä½¿ç”¨ include è¯­æ³•æ¥å®šä¹‰æ¯ä¸ªä»“åº“çš„ç‰¹å®šå‚æ•°
        include:
          # ç¬¬ 1 ä¸ªå°å·ï¼šåŸæ¥çš„ä»“åº“ (åˆ†æ”¯ main)
          - repo_url: git@github.com:twj011/blog.git
            repo_branch: main
            
          # ç¬¬ 2 ä¸ªå°å·ï¼šæ–°å¢çš„ butterfly ä»“åº“ (åˆ†æ”¯ master)
          - repo_url: git@github.com:twj011/blog-butterfly.git
            repo_branch: master

          # ä½ å¯ä»¥åœ¨è¿™é‡Œç»§ç»­æ·»åŠ æ›´å¤š...
    # -------------------------------

    steps:
      # 1. æ£€å‡ºæºä»“åº“ï¼ˆä¸»å·ï¼‰
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® SSH (å‡è®¾æ‰€æœ‰å°å·éƒ½é…ç½®äº†åŒä¸€ä¸ª Public Key)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SYNC_SSH_PRIVATE_KEY }}

      # 3. æ‰§è¡ŒåŒæ­¥
      - name: Sync to ${{ matrix.repo_url }}
        run: |
          # --- ä» Matrix è·å–åŠ¨æ€é…ç½® ---
          DEST_REPO="${{ matrix.repo_url }}"
          DEST_BRANCH="${{ matrix.repo_branch }}"
          # å‡è®¾æ‰€æœ‰åšå®¢çš„æ–‡ç« å­˜æ”¾ç›®å½•éƒ½æ˜¯è¿™ä¸ªï¼Œå¦‚æœä¸åŒä¹Ÿå¯ä»¥å†™è¿› matrix
          DEST_DIR="source/_posts"
          # ---------------------------

          SOURCE_DIR="${GITHUB_WORKSPACE}/source/_posts"
          
          # ä½¿ç”¨å“ˆå¸Œé¿å…è·¯å¾„å†²çªï¼ˆè™½ç„¶ Matrix æ˜¯åœ¨ä¸åŒ VM è·‘çš„ï¼Œä½†è¿™æ˜¯å¥½ä¹ æƒ¯ï¼‰
          TEMP_DIR="/tmp/sync-dest"

          echo "ğŸš€ Starting sync..."
          echo "Target: ${DEST_REPO}"
          echo "Branch: ${DEST_BRANCH}"

          # 1. å…‹éš†å°å·ä»“åº“
          # æ³¨æ„ï¼šè¿™é‡Œç›´æ¥æŒ‡å®šäº†åˆ†æ”¯å˜é‡
          git clone --branch "${DEST_BRANCH}" "${DEST_REPO}" "${TEMP_DIR}"

          # 2. è¿›å…¥ç›®å½•
          cd "${TEMP_DIR}"

          # 3. ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          if [ ! -d "${DEST_DIR}" ]; then
            mkdir -p "${DEST_DIR}"
          fi

          # 4. Rsync åŒæ­¥
          # --exclude ".git": ç»å¯¹ä¸è¦åŒæ­¥ .git ç›®å½•
          echo "ğŸ“‚ Syncing files..."
          rsync -av --delete --exclude ".git" "${SOURCE_DIR}/" "./${DEST_DIR}/"

          # 5. æäº¤å¹¶æ¨é€
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ Changes detected, committing..."
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add .
            git commit -m "chore: sync posts from main repo @ ${GITHUB_SHA}"
            
            git push origin "${DEST_BRANCH}"
            echo "âœ… Push successful!"
          else
            echo "ğŸ’¤ No changes detected."
          fi
          
          # æ¸…ç†
          cd ..
          rm -rf "${TEMP_DIR}"
